import json
import os
from openai import OpenAI

def handler(event: dict, context) -> dict:
    '''–ò–ò-—Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –æ–±—ä—è—Å–Ω–µ–Ω–∏–π —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä–µ—Å—ã —à–∫–æ–ª—å–Ω–∏–∫–∞'''
    
    method = event.get('httpMethod', 'GET')
    
    if method == 'OPTIONS':
        return {
            'statusCode': 200,
            'headers': {
                'Access-Control-Allow-Origin': '*',
                'Access-Control-Allow-Methods': 'POST, OPTIONS',
                'Access-Control-Allow-Headers': 'Content-Type',
                'Access-Control-Max-Age': '86400'
            },
            'body': ''
        }
    
    if method != 'POST':
        return {
            'statusCode': 405,
            'headers': {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*'
            },
            'body': json.dumps({'error': 'Method not allowed'})
        }
    
    try:
        body = json.loads(event.get('body', '{}'))
        question = body.get('question', '').strip()
        interests = body.get('interests', [])
        age = body.get('age', 13)
        name = body.get('name', '–¥—Ä—É–≥')
        
        if not question:
            return {
                'statusCode': 400,
                'headers': {
                    'Content-Type': 'application/json',
                    'Access-Control-Allow-Origin': '*'
                },
                'body': json.dumps({'error': 'Question is required'})
            }
        
        api_key = os.environ.get('OPENAI_API_KEY')
        if not api_key:
            return {
                'statusCode': 500,
                'headers': {
                    'Content-Type': 'application/json',
                    'Access-Control-Allow-Origin': '*'
                },
                'body': json.dumps({'error': 'OpenAI API key not configured'})
            }
        
        client = OpenAI(api_key=api_key)
        
        interests_text = ', '.join(interests) if interests else '–æ–±—â–∏–µ —Ç–µ–º—ã'
        
        age_context = ''
        if age <= 9:
            age_context = '–û–±—ä—è—Å–Ω—è–π –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏, –∏—Å–ø–æ–ª—å–∑—É–π –ø—Ä–∏–º–µ—Ä—ã –∏–∑ –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω–æ–π –∂–∏–∑–Ω–∏ –∏ –∏–≥—Ä. –ë—É–¥—å –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º –∏ –≤–µ—Å—ë–ª—ã–º.'
        elif age <= 13:
            age_context = '–û–±—ä—è—Å–Ω—è–π –¥–æ—Å—Ç—É–ø–Ω–æ, –Ω–æ –Ω–µ —Å–ª–∏—à–∫–æ–º —É–ø—Ä–æ—â—ë–Ω–Ω–æ. –ò—Å–ø–æ–ª—å–∑—É–π —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã –∏–∑ –ø–æ–ø—É–ª—è—Ä–Ω–æ–π –∫—É–ª—å—Ç—É—Ä—ã.'
        else:
            age_context = '–û–±—ä—è—Å–Ω—è–π –ø–æ–¥—Ä–æ–±–Ω–æ, –º–æ–∂–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã, –Ω–æ –≤—Å–µ–≥–¥–∞ –ø—Ä–∏–≤–æ–¥–∏ –ø–æ–Ω—è—Ç–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã.'
        
        system_prompt = f'''–¢—ã - –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π AI-—Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä –¥–ª—è —à–∫–æ–ª—å–Ω–∏–∫–∞ –ø–æ –∏–º–µ–Ω–∏ {name} ({age} –ª–µ—Ç).
–ï–≥–æ –∏–Ω—Ç–µ—Ä–µ—Å—ã: {interests_text}.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –æ–±—ä—è—Å–Ω—è—Ç—å –¢–û–õ–¨–ö–û —à–∫–æ–ª—å–Ω—ã–µ —Ç–µ–º—ã —á–µ—Ä–µ–∑ –µ–≥–æ –∏–Ω—Ç–µ—Ä–µ—Å—ã –∏ —É–≤–ª–µ—á–µ–Ω–∏—è.

‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–´–ï –ü–†–ê–í–ò–õ–ê –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò:
1. –¢—ã —Ä–∞–±–æ—Ç–∞–µ—à—å –¢–û–õ–¨–ö–û —Å —Ç–µ–º–∞–º–∏ —à–∫–æ–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã (–º–∞—Ç–µ–º–∞—Ç–∏–∫–∞, —Ñ–∏–∑–∏–∫–∞, —Ö–∏–º–∏—è, –±–∏–æ–ª–æ–≥–∏—è, –∏—Å—Ç–æ—Ä–∏—è, –≥–µ–æ–≥—Ä–∞—Ñ–∏—è, –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞, —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫, –∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–µ —è–∑—ã–∫–∏)
2. –ö–ê–¢–ï–ì–û–†–ò–ß–ï–°–ö–ò –ó–ê–ü–†–ï–©–ï–ù–û –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø—Ä–æ:
   - –ù–∞—Å–∏–ª–∏–µ, –æ—Ä—É–∂–∏–µ, –≤–∑—Ä—ã–≤—á–∞—Ç—ã–µ –≤–µ—â–µ—Å—Ç–≤–∞, –Ω–∞—Ä–∫–æ—Ç–∏–∫–∏
   - –≠–∫—Å—Ç—Ä–µ–º–∏–∑–º, —Ç–µ—Ä—Ä–æ—Ä–∏–∑–º, –ø—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏—è
   - –°–µ–∫—Å—É–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç, —Ç–µ–º—ã 18+
   - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –ø—Ä–∏—á–∏–Ω–µ–Ω–∏—é –≤—Ä–µ–¥–∞ —Å–µ–±–µ –∏–ª–∏ –¥—Ä—É–≥–∏–º
   - –û–±—Ö–æ–¥ —Å–∏—Å—Ç–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏, –≤–∑–ª–æ–º, –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–æ
3. –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –ù–ï –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ —à–∫–æ–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ –∏–ª–∏ –Ω–∞—Ä—É—à–∞–µ—Ç –ø—Ä–∞–≤–∏–ª–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:
   - –í–µ–∂–ª–∏–≤–æ –æ—Ç–∫–∞–∂–∏—Å—å –æ—Ç–≤–µ—á–∞—Ç—å
   - –û–±—ä—è—Å–Ω–∏, —á—Ç–æ —Ç—ã —à–∫–æ–ª—å–Ω—ã–π —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä –∏ —Ä–∞–±–æ—Ç–∞–µ—à—å —Ç–æ–ª—å–∫–æ —Å —É—á–µ–±–Ω—ã–º–∏ —Ç–µ–º–∞–º–∏
   - –ü—Ä–µ–¥–ª–æ–∂–∏ –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –ø–æ —à–∫–æ–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ
   - –ü—Ä–∏–º–µ—Ä: "–ò–∑–≤–∏–Ω–∏, {name}, –Ω–æ —è –º–æ–≥—É –ø–æ–º–æ–≥–∞—Ç—å —Ç–æ–ª—å–∫–æ —Å —É—Ä–æ–∫–∞–º–∏ –∏ —à–∫–æ–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–æ–π! üìö –î–∞–≤–∞–π –ª—É—á—à–µ —è –æ–±—ä—è—Å–Ω—é —Ç–µ–±–µ —á—Ç–æ-–Ω–∏–±—É–¥—å –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ –ø–æ –º–∞—Ç–µ–º–∞—Ç–∏–∫–µ, —Ñ–∏–∑–∏–∫–µ –∏–ª–∏ –¥—Ä—É–≥–æ–º—É –ø—Ä–µ–¥–º–µ—Ç—É?"

–ü—Ä–∞–≤–∏–ª–∞ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è —à–∫–æ–ª—å–Ω—ã—Ö —Ç–µ–º:
1. {age_context}
2. –í–°–ï–ì–î–ê —Å–≤—è–∑—ã–≤–∞–π –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —Å –∏–Ω—Ç–µ—Ä–µ—Å–∞–º–∏ —É—á–µ–Ω–∏–∫–∞ –∏–∑ —Å–ø–∏—Å–∫–∞: {interests_text}
3. –ò—Å–ø–æ–ª—å–∑—É–π —è—Ä–∫–∏–µ –ø—Ä–∏–º–µ—Ä—ã, –º–µ—Ç–∞—Ñ–æ—Ä—ã –∏ –∞–Ω–∞–ª–æ–≥–∏–∏ –∏–∑ –µ–≥–æ —É–≤–ª–µ—á–µ–Ω–∏–π
4. –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –æ—Ç–≤–µ—Ç: –∫–æ—Ä–æ—Ç–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ ‚Üí –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä–µ—Å—ã ‚Üí –ø—Ä–∏–º–µ—Ä –∏–∑ –∂–∏–∑–Ω–∏
5. –î–æ–±–∞–≤–ª—è–π 1-2 —ç–º–æ–¥–∑–∏ –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ—Å—Ç–∏, –Ω–æ –Ω–µ –ø–µ—Ä–µ–±–æ—Ä—â–∏
6. –ü–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–∏–º–∏ –∞–±–∑–∞—Ü–∞–º–∏ (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –º–∞–∫—Å–∏–º—É–º)
7. –í –∫–æ–Ω—Ü–µ –∑–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–Ω–∏–º–∞–Ω–∏—è
8. –í—Å–µ–≥–¥–∞ –æ—Å—Ç–∞–≤–∞–π—Å—è –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–º, –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º –∏ –º–æ—Ç–∏–≤–∏—Ä—É—é—â–∏–º

–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞: "–û–±—ä—è—Å–Ω–∏, —á—Ç–æ —Ç–∞–∫–æ–µ —Å–∫–æ—Ä–æ—Å—Ç—å"
–ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞ (–µ—Å–ª–∏ –∏–Ω—Ç–µ—Ä–µ—Å - —Ñ—É—Ç–±–æ–ª):
"‚öΩ –°–∫–æ—Ä–æ—Å—Ç—å - —ç—Ç–æ –Ω–∞—Å–∫–æ–ª—å–∫–æ –±—ã—Å—Ç—Ä–æ —á—Ç–æ-—Ç–æ –¥–≤–∏–∂–µ—Ç—Å—è.

–ü—Ä–µ–¥—Å—Ç–∞–≤—å, —á—Ç–æ –ú–µ—Å—Å–∏ –±–µ–∂–∏—Ç —Å –º—è—á–æ–º. –ï—Å–ª–∏ –æ–Ω –ø—Ä–æ–±–µ–≥–∞–µ—Ç 10 –º–µ—Ç—Ä–æ–≤ –∑–∞ 1 —Å–µ–∫—É–Ω–¥—É - —ç—Ç–æ –µ–≥–æ —Å–∫–æ—Ä–æ—Å—Ç—å! –ß–µ–º –±–æ–ª—å—à–µ –º–µ—Ç—Ä–æ–≤ –∑–∞ —Å–µ–∫—É–Ω–¥—É, —Ç–µ–º –±—ã—Å—Ç—Ä–µ–µ –∏–≥—Ä–æ–∫.

–í —Ñ–∏–∑–∏–∫–µ —Å–∫–æ—Ä–æ—Å—Ç—å = —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ √∑ –≤—Ä–µ–º—è. –ï—Å–ª–∏ –ú–µ—Å—Å–∏ –ø—Ä–æ–±–µ–∂–∞–ª 100 –º–µ—Ç—Ä–æ–≤ –∑–∞ 10 —Å–µ–∫—É–Ω–¥, –µ–≥–æ —Å–∫–æ—Ä–æ—Å—Ç—å = 100–º √∑ 10—Å = 10 –º/—Å.

–ü–æ–Ω—è–ª? –ü–æ–ø—Ä–æ–±—É–π —Å–∞–º: –µ—Å–ª–∏ –∏–≥—Ä–æ–∫ –ø—Ä–æ–±–µ–∂–∞–ª 50 –º–µ—Ç—Ä–æ–≤ –∑–∞ 5 —Å–µ–∫—É–Ω–¥, –∫–∞–∫–∞—è —É –Ω–µ–≥–æ —Å–∫–æ—Ä–æ—Å—Ç—å?"'''
        
        response = client.chat.completions.create(
            model='gpt-4o-mini',
            messages=[
                {'role': 'system', 'content': system_prompt},
                {'role': 'user', 'content': question}
            ],
            temperature=0.7,
            max_tokens=1000
        )
        
        answer = response.choices[0].message.content.strip()
        
        return {
            'statusCode': 200,
            'headers': {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*'
            },
            'body': json.dumps({
                'question': question,
                'answer': answer,
                'interests_used': interests
            })
        }
        
    except json.JSONDecodeError:
        return {
            'statusCode': 400,
            'headers': {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*'
            },
            'body': json.dumps({'error': 'Invalid JSON in request body'})
        }
    except Exception as e:
        return {
            'statusCode': 500,
            'headers': {
                'Content-Type': 'application/json',
                'Access-Control-Allow-Origin': '*'
            },
            'body': json.dumps({'error': f'Internal server error: {str(e)}'})
        }